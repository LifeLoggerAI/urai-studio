rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // Users can read/write their own profile, admins can read all
    match /users/{uid} {
      allow read: if request.auth.uid == uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
      allow write: if request.auth.uid == uid;
    }

    // ContentItems, Uploads, and Versions can only be read/written by the owner, admins can read all
    match /contentItems/{itemId} {
      allow read: if resource.data.ownerUid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
      allow write: if resource.data.ownerUid == request.auth.uid;

      match /uploads/{uploadId} {
        allow read: if get(/databases/$(database)/documents/contentItems/$(itemId)).data.ownerUid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
        allow write: if get(/databases/$(database)/documents/contentItems/$(itemId)).data.ownerUid == request.auth.uid;
      }

      match /versions/{versionId} {
        allow read: if get(/databases/$(database)/documents/contentItems/$(itemId)).data.ownerUid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
        allow write: if get(/databases/$(database)/documents/contentItems/$(itemId)).data.ownerUid == request.auth.uid;
      }
    }

    // Jobs and JobRuns can only be read by the owner, only system/admin can create/update
    match /jobs/{jobId} {
      allow read: if resource.data.ownerUid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
      allow create, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true; // System access is handled by service accounts
    }

    match /jobRuns/{runId} {
      allow read: if get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.ownerUid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
      allow create, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true; // System access is handled by service accounts
    }

    // AuditLogs can be read by admins, users can only read their own (or deny all user access)
    match /auditLogs/{logId} {
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
      // Optional: allow users to read their own audit logs
      // allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true || resource.data.actorUid == request.auth.uid;
    }
  }
}
