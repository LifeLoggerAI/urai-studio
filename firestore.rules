
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
        return isSignedIn() && request.auth.uid == uid;
    }

    function getUserData(uid) {
        return get(/databases/$(database)/documents/studioUsers/$(uid)).data;
    }

    function isRole(role) {
        let userData = getUserData(request.auth.uid);
        return isSignedIn() && userData != null && userData.role == role && userData.disabled != true;
    }
    
    function isOneOfRoles(roles) {
        let userData = getUserData(request.auth.uid);
        return isSignedIn() && userData != null && roles.has(userData.role) && userData.disabled != true;
    }
    
    function isFunction() {
        // In a properly configured environment, Cloud Functions will run with admin privileges.
        // This is a simple way to check if the request is coming from the backend.
        return request.auth.token.admin == true;
    }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Collection Rules ---
    match /studioUsers/{uid} {
      allow read: if isUser(uid) || isOneOfRoles(["owner", "admin"]);
      // Only owners can change roles or disable users.
      allow write: if isUser(uid) && !(request.resource.data.role is string) && !(request.resource.data.disabled is bool) || isRole("owner");
      allow create: if isUser(uid);
    }

    match /projects/{projectId} {
      allow read: if isOneOfRoles(["owner", "admin", "editor", "viewer"]);
      allow create: if isOneOfRoles(["owner", "admin", "editor"]);
      // Archived projects can only be edited by owner/admin.
      allow update: if (isOneOfRoles(["owner", "admin"])) || 
                      (isOneOfRoles(["editor"]) && resource.data.status != "archived");
    }

    match /jobs/{jobId} {
      allow read: if isOneOfRoles(["owner", "admin", "editor", "viewer"]);
      allow create: if isOneOfRoles(["owner", "admin", "editor"]);
      // State transitions and outputs can only be written by Cloud Functions.
      allow update: if isFunction() || 
                      (isOneOfRoles(["owner", "admin", "editor"]) && 
                      !('state' in request.resource.data) && 
                      !('output' in request.resource.data));
    }
    
    match /jobs/{jobId}/events/{eventId} {
        allow read: if isOneOfRoles(["owner", "admin", "editor", "viewer"]);
        allow create: if isFunction();
    }

    match /publishes/{publishId} {
      allow read: if isOneOfRoles(["owner", "admin", "editor", "viewer"]);
      allow create: if isOneOfRoles(["owner", "admin", "editor"]);
      // Approving and state changes can only be done by authorized roles or functions.
      allow update: if (isOneOfRoles(["owner", "admin"]) && request.resource.data.state == 'approved') || isFunction();
    }

    match /auditLogs/{logId} {
      allow read: if isOneOfRoles(["owner", "admin"]);
      allow create: if isFunction();
    }
    
    match /system/{docId} {
        allow read: if isOneOfRoles(["owner", "admin"]);
        allow write: if isFunction(); // System config should only be modified by functions (e.g., bootstrap)
    }
  }
}
