rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }

    function isStudioMember(studioId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/memberships/$(request.auth.uid + "_" + studioId));
    }

    function membershipDoc(studioId) {
      return get(/databases/$(database)/documents/memberships/$(request.auth.uid + "_" + studioId));
    }

    function roleIs(studioId, role) {
      return isStudioMember(studioId)
        && membershipDoc(studioId).data.role == role;
    }

    match /studios/{studioId} {
      allow read: if isStudioMember(studioId);
      allow create: if isSignedIn();
      allow update, delete: if roleIs(studioId, "owner");
    }

    match /memberships/{membershipId} {
      allow read: if isSignedIn() && membershipId.startsWith(request.auth.uid + "_");
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && membershipId.startsWith(request.auth.uid + "_");
    }

    function studioScoped() {
      return request.resource.data.studioId is string;
    }

    match /clipRequests/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create: if studioScoped() && isStudioMember(request.resource.data.studioId);
      allow update: if isStudioMember(resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /jobs/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create: if studioScoped() && isStudioMember(request.resource.data.studioId);
      allow update: if isStudioMember(resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /jobRuns/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create, update: if isStudioMember(request.resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /assets/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create: if studioScoped() && isStudioMember(request.resource.data.studioId);
      allow update: if isStudioMember(resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /outputs/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create, update: if isStudioMember(request.resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /deadLetters/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create, update: if isStudioMember(request.resource.data.studioId);
      allow delete: if roleIs(resource.data.studioId, "owner");
    }

    match /auditLogs/{id} {
      allow read: if isStudioMember(resource.data.studioId);
      allow create: if isStudioMember(request.resource.data.studioId);
      allow update, delete: if false;
    }
  }
}
