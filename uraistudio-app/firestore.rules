rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Users can read/write their own user document
    match /studioUsers/{uid} {
      allow read, write: if request.auth.uid == uid;
    }

    // Public recipes are read-only for authenticated users
    match /studioRecipes/{recipeId} {
      allow read: if request.auth != null;
      allow write: if false; // Read-only
    }

    // Users can manage their own projects
    match /studioProjects/{projectId} {
      allow get: if resource.data.ownerUid == request.auth.uid;
      allow list: if request.query.where.ownerUid == request.auth.uid;
      allow create: if request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if resource.data.ownerUid == request.auth.uid;
    }

    // Jobs can only be managed by project owners
    function isProjectOwner(projectId) {
      return get(/databases/$(database)/documents/studioProjects/$(projectId)).data.ownerUid == request.auth.uid;
    }

    match /studioJobs/{jobId} {
      allow create: if isProjectOwner(request.resource.data.projectId);
      allow get, list: if isProjectOwner(resource.data.projectId);
      allow update, delete: if isProjectOwner(resource.data.projectId);
    }
    
    // Outputs can be read by project owners, but not written
    match /studioOutputs/{outputId} {
       allow get, list: if isProjectOwner(resource.data.projectId);
       allow create, update, delete: if false; // Backend only
    }

    // Shares are publicly readable
    match /studioShares/{shareId} {
      allow get: if true;
      allow list, create, update, delete: if false;
    }

    // Audit logs are not client-accessible
    match /auditLogs/{logId} {
      allow read, write: if false;
    }
  }
}